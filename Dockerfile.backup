# # 使用 Python 3.12 官方镜像作为基础镜像
# FROM python:3.12-slim

# # 设置工作目录
# WORKDIR /app

# # 设置环境变量
# ENV PYTHONUNBUFFERED=1 \
#     PYTHONDONTWRITEBYTECODE=1 \
#     PIP_NO_CACHE_DIR=1 \
#     PIP_DISABLE_PIP_VERSION_CHECK=1

# # 安装系统依赖
# RUN apt-get update && apt-get install -y --no-install-recommends \
#     gcc \
#     g++ \
#     libffi-dev \
#     libssl-dev \
#     && rm -rf /var/lib/apt/lists/*

# # 安装 uv
# RUN pip install --no-cache-dir uv

# # 复制项目配置文件
# COPY pyproject.toml uv.lock ./

# # 使用 uv 安装依赖（使用国内镜像源，frozen 模式需要 uv.lock）
# # 注意：如果 uv.lock 不存在，可以移除 --frozen 参数
# RUN uv sync --frozen || uv sync

# # 复制项目源代码（在依赖安装后，利用 Docker 缓存层）
# COPY . .
# #
# # 暴露端口（根据 API_CALL_EXAMPLES.md，使用 8010）
# EXPOSE 8010

# # 创建日志目录
# RUN mkdir -p /app/logs

# # 设置默认命令（使用 gunicorn，生产环境配置）
# # 注意：容器中不使用 --daemon，需要前台运行以保持容器活跃
# CMD uv run gunicorn app:app \
#     -w 4 \
#     -k uvicorn.workers.UvicornWorker \
#     --bind 0.0.0.0:8010 \
#     --timeout 300 \
#     --access-logfile logs/access.log \
#     --error-logfile logs/error.log \
#     --log-level info

# 使用 Python 3.12 官方镜像作为基础镜像
FROM python:3.12-slim

# 设置工作目录
WORKDIR /app

# 设置环境变量
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    DEBIAN_FRONTEND=noninteractive

# 1. 替换系统APT源为国内源（清华大学源）
RUN sed -i 's/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list && \
    sed -i 's/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list

# 2. 可选：或者使用阿里云源（二选一，注释掉上面，取消注释下面）
# RUN echo "deb https://mirrors.aliyun.com/debian/ bookworm main non-free contrib" > /etc/apt/sources.list && \
#     echo "deb https://mirrors.aliyun.com/debian/ bookworm-updates main non-free contrib" >> /etc/apt/sources.list && \
#     echo "deb https://mirrors.aliyun.com/debian-security bookworm-security main" >> /etc/apt/sources.list

# 安装系统依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    libffi-dev \
    libssl-dev \
    ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# 3. 设置pip国内镜像源（清华源）
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip config set global.trusted-host mirrors.tuna.tsinghua.edu.cn

# 4. 安装uv（使用国内镜像源）
RUN pip install --no-cache-dir uv \
    -i https://pypi.tuna.tsinghua.edu.cn/simple \
    --trusted-host mirrors.tuna.tsinghua.edu.cn

# 5. 配置uv使用国内源
RUN uv config set install.index-url https://pypi.tuna.tsinghua.edu.cn/simple

# 复制项目配置文件
COPY pyproject.toml uv.lock ./

# 使用 uv 安装依赖（使用国内镜像源）
# 注意：如果 uv.lock 不存在，可以移除 --frozen 参数
RUN uv sync --frozen -i https://pypi.tuna.tsinghua.edu.cn/simple || uv sync -i https://pypi.tuna.tsinghua.edu.cn/simple

# 复制项目源代码（在依赖安装后，利用 Docker 缓存层）
COPY . .

# 暴露端口（根据 API_CALL_EXAMPLES.md，使用 8010）
EXPOSE 8010

# 创建日志目录
RUN mkdir -p /app/logs

# 设置默认命令（使用 gunicorn，生产环境配置）
# 注意：容器中不使用 --daemon，需要前台运行以保持容器活跃
CMD uv run gunicorn app:app \
    -w 4 \
    -k uvicorn.workers.UvicornWorker \
    --bind 0.0.0.0:8010 \
    --timeout 300 \
    --access-logfile logs/access.log \
    --error-logfile logs/error.log \
    --log-level info